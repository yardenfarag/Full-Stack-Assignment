import R from"fastify";import w from"@fastify/cors";import{readFileSync as F}from"fs";import{join as b}from"path";function p(e,a=1){let c=Math.max(1,Math.floor(a)),i=Math.max(1,Math.ceil(e.length/100)),r=(c-1)*100,s=r+100;return{data:e.slice(r,s),pagination:{page:c,pageSize:100,totalPages:i}}}function f(){let e=Math.random();return e<.1?{shouldError:!0,statusCode:500,body:{error:"Internal Server Error",message:"An unexpected error occurred. Please retry your request."}}:e<.15?{shouldError:!0,statusCode:429,body:{error:"Rate Limit Exceeded",message:"Too many requests. Please wait before retrying.",retryAfterMs:1e3}}:{shouldError:!1}}var l=5e3;function y(e){return new Promise(a=>setTimeout(a,e))}var o={type:"object",properties:{page:{type:"number"}}};async function h(e){e.get("/campaigns",{schema:{querystring:o}},async a=>p(e.data.campaigns,a.query.page))}async function S(e){e.get("/ads",{schema:{querystring:{...o,properties:{...o.properties,campaignIds:{type:"string"},dateFrom:{type:"string"},dateTo:{type:"string"}}}}},async a=>{let{page:c,campaignIds:i,dateFrom:r,dateTo:s}=a.query,n=e.data.ads;if(i){let t=new Set(i.split(",").filter(Boolean));n=n.filter(g=>t.has(g.campaign_id))}return r&&(n=n.filter(t=>t.date_end>=r)),s&&(n=n.filter(t=>t.date_start<=s)),p(n,c)})}async function v(e){e.get("/creatives",{schema:{querystring:o}},async a=>p(e.data.creatives,a.query.page))}async function _(e){e.get("/insights",{schema:{querystring:{...o,properties:{...o.properties,campaignIds:{type:"string"},adIds:{type:"string"},dateFrom:{type:"string"},dateTo:{type:"string"}}}}},async a=>{let{page:c,campaignIds:i,adIds:r,dateFrom:s,dateTo:n}=a.query,t=e.data.insights;if(i){let g=new Set(i.split(",").filter(Boolean));t=t.filter(m=>g.has(m.campaign_id))}if(r){let g=new Set(r.split(",").filter(Boolean));t=t.filter(m=>g.has(m.ad_id))}return s&&(t=t.filter(g=>g.date>=s)),n&&(t=t.filter(g=>g.date<=n)),p(t,c)})}import{readFileSync as I}from"fs";import{join as E}from"path";var x=I(E(process.cwd(),"..","config.json"),"utf-8"),u=JSON.parse(x);var T=b(process.cwd(),"../data");function d(e){let a=F(b(T,e),"utf-8");return JSON.parse(a)}async function P(){let e=d("campaigns.json"),a=d("ads.json"),c=d("creatives.json"),i=d("insights.json");console.log(`Loaded data: ${e.length} campaigns, ${a.length} ads, ${c.length} creatives, ${i.length} insights`);let r=R({logger:!0});await r.register(w,{origin:!0}),r.addHook("onRequest",async(s,n)=>{let t=f();t.shouldError&&n.code(t.statusCode).send(t.body)}),r.decorate("data",{campaigns:e,ads:a,creatives:c,insights:i}),await r.register(h,{prefix:"/api"}),await r.register(S,{prefix:"/api"}),await r.register(v,{prefix:"/api"}),await r.register(_,{prefix:"/api"}),r.addHook("onSend",async(s,n,t)=>(n.statusCode>=200&&n.statusCode<300&&await y(l),t));try{await r.listen({port:u.ports.dataServer,host:"0.0.0.0"}),console.log(`Data server running on http://localhost:${u.ports.dataServer}`)}catch(s){r.log.error(s),process.exit(1)}}P();
